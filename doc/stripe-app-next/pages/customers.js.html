<!DOCTYPE html>
<html>
<head>
  <title>customers.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "stripe-app-next\\pages\\customers.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>customers.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">import</span> firebase <span class="hljs-keyword">from</span> <span class="hljs-string">"firebase/app"</span>;
<span class="hljs-keyword">import</span> React, { useState, useEffect, Suspense } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { fetchFromAPI } <span class="hljs-keyword">from</span> <span class="hljs-string">'./api/helpers'</span>;
<span class="hljs-keyword">import</span> { CardElement, useStripe, useElements } <span class="hljs-keyword">from</span> <span class="hljs-string">'@stripe/react-stripe-js'</span>;
<span class="hljs-keyword">import</span> { useUser, AuthCheck } <span class="hljs-keyword">from</span> <span class="hljs-string">'reactfire'</span>;
<span class="hljs-keyword">import</span> {db, auth} <span class="hljs-keyword">from</span> <span class="hljs-string">"./api/firebase"</span>;





<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SignIn</span>(<span class="hljs-params"></span>)</span>{
    <span class="hljs-keyword">const</span> signIn = <span class="hljs-keyword">async</span> ()=&gt;{
        <span class="hljs-keyword">const</span> credential = <span class="hljs-keyword">await</span> auth.signInWithPopup(
            <span class="hljs-keyword">new</span> firebase.auth.GoogleAuthProvider()
        )
        <span class="hljs-keyword">const</span> {uid,email} = credential.user;
        db.collection(<span class="hljs-string">"users"</span>).doc(uid).set({email},{<span class="hljs-attr">merge</span>:<span class="hljs-literal">true</span>})
    }
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{signIn}</span>&gt;</span>
            Sign In With Google
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SignOut</span>(<span class="hljs-params">props</span>)</span>{
    <span class="hljs-keyword">return</span> props.user &amp;&amp;(
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>auth.signOut()}&gt;Sign Out User {props.user.uid}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    )
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SaveCard</span>(<span class="hljs-params">props</span>)</span>{
    <span class="hljs-keyword">const</span> stripe = useStripe()
    <span class="hljs-keyword">const</span> elements = useElements()
    <span class="hljs-keyword">const</span> user = useUser()

    <span class="hljs-keyword">const</span> [setupIntent,setSetupIntent] = useState()
    <span class="hljs-keyword">const</span> [wallet,setWallet] = useState()
     useEffect(<span class="hljs-function"><span class="hljs-params">()</span>=&gt;</span>{
         getWallet()
     },[user])
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>only when its first mounted or user is changed</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> createSetupIntent = <span class="hljs-keyword">async</span> (event)=&gt;{
        <span class="hljs-keyword">const</span> si = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">"wallet"</span>)
        setSetupIntent(si)

    }
    <span class="hljs-keyword">const</span> getWallet = <span class="hljs-keyword">async</span> ()=&gt;{
        <span class="hljs-keyword">if</span>(user){
          <span class="hljs-keyword">const</span> paymentMethods = <span class="hljs-keyword">await</span> fetchFromAPI(<span class="hljs-string">"wallet"</span>,{<span class="hljs-attr">method</span>:<span class="hljs-string">"GET"</span>})
            setWallet(paymentMethods)


        }
    }
    <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-keyword">async</span> (event) =&gt; {
        event.preventDefault();

        <span class="hljs-keyword">const</span> cardElement = elements.getElement(CardElement);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Confirm Card Setup</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> {
            <span class="hljs-attr">setupIntent</span>: updatedSetupIntent,
            error,
        } = <span class="hljs-keyword">await</span> stripe.confirmCardSetup(setupIntent.client_secret, {
            <span class="hljs-attr">payment_method</span>: { <span class="hljs-attr">card</span>: cardElement },
        });

        <span class="hljs-keyword">if</span> (error) {
            alert(error.message);
            <span class="hljs-built_in">console</span>.log(error);
        } <span class="hljs-keyword">else</span> {
            setSetupIntent(updatedSetupIntent);
            <span class="hljs-keyword">await</span> getWallet();
            alert(<span class="hljs-string">'Success! Card added to your wallet'</span>);
        }
    };


    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">AuthCheck</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">SignIn</span>/&gt;</span>}&gt;
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>



                  <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSumbit}</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">CardElement</span>/&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">{</span>"<span class="hljs-attr">submit</span>"}&gt;</span>Attach<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span>

                  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{createSetupIntent}</span>&gt;</span>
                      Attach New Credit Card
                  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>




                  <span class="hljs-tag">&lt;<span class="hljs-name">select</span>&gt;</span>
                      {wallet.map((paymentSource)=&gt;(
                          <span class="hljs-tag">&lt;<span class="hljs-name">CreditCard</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{paymentSource.id}</span> <span class="hljs-attr">card</span>=<span class="hljs-string">{paymentSource.card}/</span>&gt;</span>
                      ))}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">SignOut</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}/</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

            <span class="hljs-tag">&lt;/<span class="hljs-name">AuthCheck</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )

}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CreditCard</span>(<span class="hljs-params">props</span>)</span>{
    <span class="hljs-keyword">const</span> {last4, brand, exp_month,exp_year} = props.card
    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">option</span>&gt;</span>
            {brand} **** **** **** **** {last4} expires {exp_month}/{exp_year}
        <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Customers</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">loading</span> <span class="hljs-attr">user</span>'}&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">SaveCard</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
    );
}
</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
